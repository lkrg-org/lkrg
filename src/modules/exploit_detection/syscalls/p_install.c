/*
 * pi3's Linux kernel Runtime Guard
 *
 * Component:
 *  - Generic install and uninstall functions
 *
 * Notes:
 *  - None
 *
 * Caveats:
 *  - None
 *
 * Timeline:
 *  - Created: 4.V.2020
 *
 * Author:
 *  - Mariusz Zaborski (https://oshogbo.vexillium.org/)
 *
 */

#include "../../../p_lkrg_main.h"

int p_install_hook(struct kretprobe *kretprobe, char *state) {

   int p_ret;
   const char *name = kretprobe->kp.symbol_name;

   p_debug_log(P_LKRG_STRONG_DBG,
          "Entering function <p_install_hook> for %s\n",
          name);

   if ( (p_ret = register_kretprobe(kretprobe)) < 0) {
      p_print_log(P_LKRG_ERR, "[kretprobe] register_kretprobe() for <%s> failed! [err=%d]\n",
                  name, p_ret);
      goto p_install_hook_out;
   }

   p_print_log(P_LKRG_INFO, "Planted [kretprobe] <%s> at: 0x%lx\n",
               name,
               (unsigned long)kretprobe->kp.addr);
   *state = 0x01;

p_install_hook_out:

   p_debug_log(P_LKRG_STRONG_DBG,
          "Leaving function <p_install_hook> for %s (p_ret => %d)\n",
          name, p_ret);

   return p_ret;
}

void p_uninstall_hook(struct kretprobe *kretprobe, char *state) {

   const char *name = kretprobe->kp.symbol_name;

   p_debug_log(P_LKRG_STRONG_DBG,
          "Entering function <p_uninstall_hook> for %s\n",
           name);

   if (!*state) {
      p_print_log(P_LKRG_INFO, "[kretprobe] <%s> at 0x%lx is NOT installed\n",
                  name,
                  (unsigned long)kretprobe->kp.addr);
   } else {
      unregister_kretprobe(kretprobe);
      p_print_log(P_LKRG_INFO, "Removing [kretprobe] <%s> at 0x%lx nmissed[%d]\n",
                  name,
                  (unsigned long)kretprobe->kp.addr,
                  kretprobe->nmissed);
      *state = 0x0;
   }

   p_debug_log(P_LKRG_STRONG_DBG,
          "Leaving function <p_uninstall_hook> %s\n",
          name);
}
